name: Issue Analysis with Claude

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

jobs:
  analyze-issue:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Analyze Issue with Claude
        uses: anthropics/claude-code-action@main
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          claude_args: "--allowedTools Bash(gh *)"
          prompt: |
            Analysiere das folgende Issue und erstelle einen strukturierten Bericht. Dies ist eine erneute Analyse aufgrund von Ã„nderungen am Issue.

            REPO: ${{ github.repository }}
            ISSUE_NUMBER: ${{ github.event.issue.number || github.event.comment.issue_url }}

            **Hinweis:** PrÃ¼fe ob bereits eine Analyse existiert. Falls ja, aktualisiere den bestehenden Analyse-Kommentar oder erstelle einen neuen mit "ğŸ”„ Aktualisierte Analyse".

            Du bist ein technischer Analyst, der GitHub Issues auf QualitÃ¤t und VollstÃ¤ndigkeit Ã¼berprÃ¼ft.

            **Analyse-Kriterien:**

            1. **User Story Struktur:**
               - Ist eine User Story vorhanden?
               - Folgt sie dem Format: "Als [Rolle] mÃ¶chte ich [Funktionsanforderung], um [Mehrwert fÃ¼r Rolle]"?
               - Sind Rolle, Funktionsanforderung und Mehrwert klar definiert?

            2. **Code-Relevanz:**
               - Gibt es einen erkennbaren Bezug zu existierendem Code?
               - Welche Komponenten/Module sind betroffen?
               - Basierend auf der Projektstruktur (Astro, React, Firebase): Wo wÃ¼rde die Implementierung stattfinden?

            3. **VollstÃ¤ndigkeit:**
               - Sind alle notwendigen Informationen vorhanden?
               - Welche LÃ¼cken existieren in der Beschreibung?
               - Fehlen Akzeptanzkriterien oder technische Details?

            4. **Wichtige Ãœberlegungen:**
               - Was sollte bei der Implementierung bedacht werden?
               - Gibt es AbhÃ¤ngigkeiten zu anderen Features?
               - Welche Auswirkungen hat das Feature auf andere Systemteile?

            5. **Sicherheitsrisiken:**
               - Welche Sicherheitsaspekte mÃ¼ssen beachtet werden?
               - Gibt es potenzielle Schwachstellen?
               - Sind Authentifizierung/Autorisierung betroffen?

            **Bitte erstelle einen Kommentar im Issue mit folgendem Format:**

            ## ğŸ¤– Automatische Issue-Analyse durch Claude

            ## ğŸ“‹ Issue-QualitÃ¤tsbewertung

            âœ… **QualitÃ¤t:** [AUSREICHEND / VERBESSERUNGSBEDARF]

            ## ğŸ¯ User Story Analyse

            [Bewertung der User Story Struktur]

            ## ğŸ” Code-Relevanz

            [Analyse des Code-Bezugs und betroffener Komponenten]

            ## âš ï¸ Fehlende Informationen

            [Liste der LÃ¼cken in der Beschreibung]

            ## ğŸ’¡ Implementierungshinweise

            [Wichtige Ãœberlegungen fÃ¼r die Implementierung]

            ## ğŸ”’ Sicherheitsaspekte

            [Identifizierte Sicherheitsrisiken und Empfehlungen]

            ## ğŸš€ NÃ¤chste Schritte

            [Wenn AUSREICHEND: Label "ready-for-implementation" setzen und Feature Branch Name vorschlagen]
            [Wenn VERBESSERUNGSBEDARF: Label "needs-clarification" setzen und konkrete Fragen stellen]

            ---
            *Diese Analyse wurde automatisch erstellt.*

