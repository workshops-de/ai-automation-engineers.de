name: ðŸ“… Weekly Newsletter Generation

on:
  schedule:
    # Runs every Friday at 9:00 AM CET (8:00 AM UTC)
    - cron: '0 8 * * 5'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      generate_content:
        description: 'Generate newsletter with AI content'
        required: false
        default: true
        type: boolean

jobs:
  generate-newsletter:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Collect articles from last 7 days
        run: |
          chmod +x scripts/collect-weekly-articles.js
          node scripts/collect-weekly-articles.js --days 7 --output weekly-articles.json
          echo "ðŸ“Š Articles collected:"
          if [ -f weekly-articles.json ]; then
            # Show summary of collected articles
            node -e "
              const data = JSON.parse(require('fs').readFileSync('weekly-articles.json', 'utf8'));
              console.log(\`ðŸ“… Date Range: \${data.summary.dateRange.start} - \${data.summary.dateRange.end}\`);
              console.log(\`ðŸ“ Total Articles: \${data.summary.total}\`);
              console.log('ðŸ“‚ Categories:');
              Object.entries(data.summary.categories).forEach(([cat, info]) => {
                console.log(\`  â€¢ \${cat}: \${info.count} articles\`);
              });
              console.log('ðŸŽ¯ Top Articles:');
              data.summary.topArticles.slice(0, 3).forEach((article, i) => {
                console.log(\`  \${i+1}. \${article.title} (\${article.date})\`);
              });
            "
          else
            echo "âš ï¸ No articles file generated"
          fi

      - name: ðŸ“… Generate newsletter structure
        run: |
          chmod +x scripts/generate-newsletter.js
          node scripts/generate-newsletter.js

      - name: ðŸ” Check for new newsletter
        id: check_changes
        run: |
          if git status --porcelain | grep -q "src/pages/newsletter/"; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ New newsletter detected"
            
            # Get the folder name for the new newsletter
            NEW_FOLDER=$(git status --porcelain | grep "src/pages/newsletter/" | head -1 | sed 's/.*src\/pages\/newsletter\///' | cut -d'/' -f1)
            echo "folder_name=$NEW_FOLDER" >> $GITHUB_OUTPUT
            echo "Newsletter folder: $NEW_FOLDER"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No new newsletter generated (may already exist)"
          fi

      - name: ðŸ“ Get current date info
        id: date_info
        run: |
          CURRENT_DATE=$(date +%Y-%m-%d)
          WEEK_NUMBER=$(date +%V)
          YEAR=$(date +%Y)
          FRIDAY_DATE=$(date +%Y-%m-%d)
          
          echo "current_date=$CURRENT_DATE" >> $GITHUB_OUTPUT
          echo "week_number=$WEEK_NUMBER" >> $GITHUB_OUTPUT
          echo "year=$YEAR" >> $GITHUB_OUTPUT
          echo "friday_date=$FRIDAY_DATE" >> $GITHUB_OUTPUT
          
          echo "Current date: $CURRENT_DATE"
          echo "Week number: $WEEK_NUMBER"
          echo "Year: $YEAR"

      - name: ðŸ¤– Add AI generation notice with articles data
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          NEWSLETTER_FILE="src/pages/newsletter/${{ steps.check_changes.outputs.folder_name }}/index.md"
          
          if [ -f "$NEWSLETTER_FILE" ]; then
            # Generate articles summary for AI prompt
            ARTICLES_SUMMARY=""
            if [ -f weekly-articles.json ]; then
              ARTICLES_SUMMARY=$(node -e "
                const fs = require('fs');
                const data = JSON.parse(fs.readFileSync('weekly-articles.json', 'utf8'));
                if (data.summary.total > 0) {
                  console.log('ðŸ“š AVAILABLE ARTICLES FROM LAST 7 DAYS:');
                  console.log('');
                  console.log(\`Total: \${data.summary.total} articles (\${data.summary.dateRange.start} - \${data.summary.dateRange.end})\`);
                  console.log('');
                  console.log('ðŸŽ¯ TOP ARTICLES FOR NEWSLETTER:');
                  data.references.slice(0, 8).forEach((article, i) => {
                    console.log(\`\${i+1}. \${article.title}\`);
                    console.log(\`   URL: \${article.url}\`);
                    console.log(\`   Category: \${article.category} | Section: \${article.suggestedSection}\`);
                    console.log(\`   Description: \${article.description.substring(0, 100)}...\`);
                    console.log('');
                  });
                  console.log('ðŸ“‚ CATEGORIES BREAKDOWN:');
                  Object.entries(data.summary.categories).forEach(([cat, info]) => {
                    console.log(\`â€¢ \${cat}: \${info.count} articles\`);
                  });
                } else {
                  console.log('â„¹ï¸  No articles found in the last 7 days');
                }
              " 2>/dev/null || echo "No articles data available")
            else
              ARTICLES_SUMMARY="No articles data available"
            fi
            
            # Add a comment at the top of the file for AI content generation
            cat > temp_newsletter.md << EOF
          <!--
          ðŸ¤– AI CONTENT GENERATION NEEDED
          
          This newsletter was auto-generated with real articles from the last 7 days.
          
          Instructions:
          1. Use the prompt from: prompts/weekly-newsletter-prompt.md
          2. Use the articles data below to fill the newsletter content
          3. Replace [PLACEHOLDER] content with real information from the articles
          4. Ensure all content is B2B focused and enterprise-relevant
          
          $ARTICLES_SUMMARY
          
          Template placeholders to replace:
          - [BUSINESS-IMPACT], [AUTOMATISIERUNG-POTENZIAL], [ENTERPRISE-RELEVANZ] in stories
          - [SPEZIFISCHE ZIELGRUPPE] based on article content
          - Links are already provided from collected articles
          
          Week: ${{ steps.date_info.outputs.week_number }}/${{ steps.date_info.outputs.year }}
          Generated: ${{ steps.date_info.outputs.current_date }}
          -->
          
          EOF
            
            cat "$NEWSLETTER_FILE" >> temp_newsletter.md
            mv temp_newsletter.md "$NEWSLETTER_FILE"
            
            echo "âœ… Added AI generation instructions with articles data to newsletter"
          fi

      - name: ðŸŽ¯ Create Pull Request
        if: steps.check_changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            feat(newsletter): add weekly ai-automation newsletter KW${{ steps.date_info.outputs.week_number }}/${{ steps.date_info.outputs.year }}
            
            - Auto-generated newsletter structure for week ${{ steps.date_info.outputs.week_number }}
            - Ready for AI content generation using prompts/weekly-newsletter-prompt.md  
            - Includes course promotion components
            - B2B focus on AI-automation and enterprise tools
          branch: newsletter/week-${{ steps.date_info.outputs.week_number }}-${{ steps.date_info.outputs.year }}
          title: "ðŸ“… Weekly Newsletter KW${{ steps.date_info.outputs.week_number }}/${{ steps.date_info.outputs.year }} - Ready for AI Content"
          body: |
            ## ðŸ“… Weekly Newsletter KW${{ steps.date_info.outputs.week_number }}/${{ steps.date_info.outputs.year }}
            
            Auto-generated newsletter structure ready for content creation.
            
            ### ðŸ¤– Next Steps (AI Content Generation)
            
            1. **Use the AI Prompt**: Check `prompts/weekly-newsletter-prompt.md` for detailed instructions
            2. **Review Articles Data**: Newsletter includes articles from the last 7 days automatically
            3. **Fill Business Context**: Replace `[BUSINESS-IMPACT]`, `[ENTERPRISE-RELEVANZ]` with real insights
            4. **Verify Links**: All article links are pre-populated from our blog
            5. **Review**: Ensure B2B focus and enterprise relevance
            
            ### ðŸ“š Articles Auto-Included
            The newsletter structure is pre-populated with articles from the last 7 days. Check the comment section in the newsletter file for the complete list.
            
            ### ðŸ“ Generated Files
            - `src/pages/newsletter/${{ steps.check_changes.outputs.folder_name }}/index.md`
            
            ### ðŸŽ¯ Content Focus
            - AI-Automation Tools (N8N, Langflow, etc.)
            - Enterprise AI Solutions
            - Developer Tools (GitHub Copilot, Cursor, etc.)  
            - Business Process Automation
            - Multi-Agent Systems & MCP
            
            ### âœ… Features Included
            - âœ… Course promotion components (automatically integrated)
            - âœ… Responsive design
            - âœ… SEO optimized frontmatter
            - âœ… Professional B2B tone
            
            **Generated on**: ${{ steps.date_info.outputs.current_date }}
            **Week**: ${{ steps.date_info.outputs.week_number }}/${{ steps.date_info.outputs.year }}
          labels: |
            newsletter
            automated
            content-needed
          assignees: |
            ${{ github.repository_owner }}

      - name: ðŸ“Š Summary
        run: |
          echo "## ðŸ“… Weekly Newsletter Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: ${{ steps.date_info.outputs.current_date }}" >> $GITHUB_STEP_SUMMARY
          echo "**Week**: ${{ steps.date_info.outputs.week_number }}/${{ steps.date_info.outputs.year }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Add articles summary to GitHub summary
          if [ -f weekly-articles.json ]; then
            echo "### ðŸ“š Articles Collected" >> $GITHUB_STEP_SUMMARY
            node -e "
              try {
                const fs = require('fs');
                const data = JSON.parse(fs.readFileSync('weekly-articles.json', 'utf8'));
                console.log(\`**Total Articles**: \${data.summary.total}\`);
                console.log(\`**Date Range**: \${data.summary.dateRange.start} to \${data.summary.dateRange.end}\`);
                console.log('**Categories**:');
                Object.entries(data.summary.categories).forEach(([cat, info]) => {
                  console.log(\`- \${cat}: \${info.count} articles\`);
                });
              } catch(e) {
                console.log('No articles data available');
              }
            " >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.check_changes.outputs.changes }}" = "true" ]; then
            echo "âœ… **Status**: Newsletter generated with real articles from last 7 days" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ **Folder**: ${{ steps.check_changes.outputs.folder_name }}" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”€ **PR**: Created pull request for content refinement" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **Status**: Newsletter already exists for this week" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ¤– Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the generated newsletter with pre-populated articles" >> $GITHUB_STEP_SUMMARY  
          echo "2. Use AI prompt from \`prompts/weekly-newsletter-prompt.md\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Replace business impact placeholders with insights" >> $GITHUB_STEP_SUMMARY
          echo "4. Articles and links are already included from last 7 days" >> $GITHUB_STEP_SUMMARY
          echo "5. Review and merge the pull request" >> $GITHUB_STEP_SUMMARY
